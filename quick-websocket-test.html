<!DOCTYPE html>
<html>
<head>
    <title>Quick WebSocket Test</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.2/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .status { padding: 10px; margin: 10px 0; border-radius: 5px; }
        .connected { background: #d4edda; color: #155724; }
        .disconnected { background: #f8d7da; color: #721c24; }
        .notification { background: #e3f2fd; padding: 10px; margin: 5px 0; border-left: 4px solid #2196f3; }
        button { padding: 10px 15px; margin: 5px; cursor: pointer; }
        input { padding: 8px; margin: 5px; width: 200px; }
    </style>
</head>
<body>
    <h2>ðŸ”” WebSocket Notification Test</h2>
    
    <div id="status" class="status disconnected">Disconnected</div>
    
    <div>
        <input type="text" id="userId" placeholder="Enter User ID (e.g., 1)" value="1">
        <button onclick="connect()">Connect</button>
        <button onclick="disconnect()">Disconnect</button>
    </div>
    
    <div>
        <h3>Send Test Notification:</h3>
        <input type="text" id="testMessage" placeholder="Test message" value="Hello from WebSocket!">
        <button onclick="sendTest()">Send Test</button>
    </div>
    
    <div>
        <h3>Received Notifications:</h3>
        <div id="notifications" style="border: 1px solid #ddd; height: 300px; overflow-y: auto; padding: 10px;">
            No notifications yet...
        </div>
    </div>

    <script>
        let stompClient = null;
        let userId = null;

        function connect() {
            userId = document.getElementById('userId').value;
            if (!userId) {
                alert('Please enter a User ID');
                return;
            }

            const socket = new SockJS('http://localhost:8085/ws');
            stompClient = Stomp.over(socket);

            stompClient.connect({}, function (frame) {
                console.log('Connected: ' + frame);
                document.getElementById('status').textContent = 'Connected';
                document.getElementById('status').className = 'status connected';

                // Subscribe to personal notifications
                stompClient.subscribe('/user/queue/notifications', function (notification) {
                    const data = JSON.parse(notification.body);
                    addNotification(data);
                });

                // Subscribe to broadcast notifications
                stompClient.subscribe('/topic/notifications', function (notification) {
                    const data = JSON.parse(notification.body);
                    addNotification(data, 'BROADCAST');
                });

                // Send subscription
                stompClient.send("/app/subscribe", {}, JSON.stringify({
                    'userId': userId
                }));

            }, function (error) {
                console.error('Connection error:', error);
                document.getElementById('status').textContent = 'Connection Failed';
                document.getElementById('status').className = 'status disconnected';
            });
        }

        function disconnect() {
            if (stompClient !== null) {
                stompClient.disconnect();
            }
            document.getElementById('status').textContent = 'Disconnected';
            document.getElementById('status').className = 'status disconnected';
        }

        function sendTest() {
            const message = document.getElementById('testMessage').value;
            if (!message) {
                alert('Please enter a message');
                return;
            }

            fetch('http://localhost:8085/api/notifications/test', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    userId: userId,
                    message: message,
                    type: 'TEST'
                })
            }).then(response => response.json())
              .then(data => console.log('Test sent:', data))
              .catch(error => console.error('Error:', error));
        }

        function addNotification(data, source = 'PERSONAL') {
            const div = document.createElement('div');
            div.className = 'notification';
            div.innerHTML = `
                <strong>[${source}] ${data.type || 'NOTIFICATION'}</strong><br>
                ${data.message}<br>
                <small>${new Date().toLocaleTimeString()}</small>
            `;
            
            const container = document.getElementById('notifications');
            container.insertBefore(div, container.firstChild);
        }

        // Auto-connect for testing
        setTimeout(() => {
            connect();
        }, 1000);
    </script>
</body>
</html>
